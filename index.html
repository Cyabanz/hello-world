<!-- ---- FRONTEND: Simple HTML & JS ---- -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hyperbeam 5-min VM Session</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        #session { margin-top: 2em; }
        iframe { width: 800px; height: 450px; border: 1px solid #ccc; }
        button { margin-right: 1em; }
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        #modalContent {
            background: #fff;
            padding: 2em;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            min-width: 200px;
        }
        #historyList { margin: 0; padding-left: 1.3em; }
        #historyList li { margin-bottom: 0.3em; }
    </style>
</head>
<body>
    <h1>Hyperbeam 5-Minute VM Session</h1>
    <div>
        <button id="startBtn">Start VM Session (5 min)</button>
        <button id="killBtn" disabled>Kill Session</button>
        <span id="timer"></span>
    </div>
    <div id="session"></div>

    <div style="margin-top:2em;">
        <h2>Session History</h2>
        <button onclick="loadHistory()">Refresh History</button>
        <ul id="historyList"></ul>
    </div>

    <!-- 10-second warning modal -->
    <div id="modal">
        <div id="modalContent">
            <strong>Session will end in 10 seconds!</strong><br>
            Please save your work.
            <br><br>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const killBtn = document.getElementById('killBtn');
        const sessionDiv = document.getElementById('session');
        const timerSpan = document.getElementById('timer');
        let interval = null;
        let warned = false;

        async function checkStatus() {
            const res = await fetch('http://localhost:3000/status');
            const data = await res.json();
            if (data.active) {
                showSession(data.url);
                killBtn.disabled = false;
                startBtn.disabled = true;
                startTimer(data.timeLeft);
            } else {
                hideSession();
            }
        }

        function startTimer(msLeft) {
            clearInterval(interval);
            warned = false;
            let end = Date.now() + msLeft;
            interval = setInterval(() => {
                let remain = Math.max(0, end - Date.now());
                let min = Math.floor(remain / 60000);
                let sec = Math.floor((remain % 60000) / 1000);
                timerSpan.textContent = `Time left: ${min}:${sec.toString().padStart(2, '0')}`;
                // 10-second warning modal
                if (remain <= 10000 && !warned) {
                    warned = true;
                    showModal();
                }
                if (remain <= 0) {
                    clearInterval(interval);
                    timerSpan.textContent = "";
                    hideSession();
                    loadHistory();
                }
            }, 500);
        }

        function showSession(url) {
            sessionDiv.innerHTML = `<iframe src="${url}" allow="clipboard-read; clipboard-write; autoplay; fullscreen" allowfullscreen></iframe>`;
            killBtn.disabled = false;
            startBtn.disabled = true;
        }
        function hideSession() {
            sessionDiv.innerHTML = '';
            killBtn.disabled = true;
            startBtn.disabled = false;
            timerSpan.textContent = "";
            clearInterval(interval);
        }

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            const res = await fetch('http://localhost:3000/start', { method: 'POST' });
            if (res.ok) {
                const data = await res.json();
                showSession(data.url);
                killBtn.disabled = false;
                checkStatus();
                loadHistory();
            } else {
                alert("Could not start session!");
                startBtn.disabled = false;
            }
        };
        killBtn.onclick = async () => {
            killBtn.disabled = true;
            await fetch('http://localhost:3000/kill', { method: 'POST' });
            hideSession();
            loadHistory();
        };

        // Poll session status every 5 seconds
        setInterval(checkStatus, 5000);
        checkStatus();

        // Session History
        async function loadHistory() {
            const res = await fetch('http://localhost:3000/history');
            const data = await res.json();
            let list = document.getElementById('historyList');
            list.innerHTML = "";
            if (data.history.length === 0) {
                list.innerHTML = "<li>No sessions yet.</li>";
                return;
            }
            data.history.forEach((h, i) => {
                let started = new Date(h.startedAt).toLocaleString();
                let ended = h.endedAt ? new Date(h.endedAt).toLocaleString() : "<em>In Progress</em>";
                list.innerHTML += `<li>Session ${i+1}: Started <b>${started}</b>, Ended <b>${ended}</b></li>`;
            });
        }
        window.onload = loadHistory;

        // 10-second warning modal
        function showModal() {
            document.getElementById('modal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
    </script>
</body>
</html>
